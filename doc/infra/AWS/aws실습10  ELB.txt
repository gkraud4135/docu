[ELB 테스트 실습을 위한 네트워크 구성]

1.aws 관리콘솔에 로그온합니다.
2.서비스 찾기 입력상자에서 VPC를 입력합니다.
3.좌측 VPC 대시보드아래 VPC를 클릭하고 VPC생성 단추를 클릭합니다.
4.VPC생성화면에서 이름태그부분에 ELB-VPC라고 입력하고 IPv4 CIDR 블록에 10.0.0.0/16 을 입력하고 VPC생성단추를 눌러 생성을 확인합니다  
5.좌측 VPC 대시보드아래 VPC를 클릭하여 생성된 ELB-VPC가 표시되는가 확인합니다.
6. 좌측 VPC 대시보드아래 서브넷을 클릭하여 가용영역A와 C영역을 대상으로 두개의 서브넷을 만듭니다
먼저 가용영역 A에 서브넷 A를 생성하고 가용영역C에 추가 서브넷 C를 생성합니다. 
7.서브넷 생성단추를 클릭하여 서브넷 생성화면에서 이름 태그는 "AWS-ELB subnet2a"를 입력  VPC는 "AWS-ELB" 가용영역은 "ap-northeast-2a"를 선택합니다.
8.IPv4 CIDR블록 입력상자에 "10.0.1.0/24"를 입력 후  생성단추를 누릅니다.
다음과 같은 서브넷이 생성되었습니다.라는 표시가 되면 닫기를 클릭합니다.
서브넷 ID subnet-03024e3522db1c7ae와 같은 서브넷ID가 표시되는가 확인합니다.
9.서브넷 생성단추를 클릭하여  이번에는 이름 태그는 "AWS-ELB subnet2c"를 입력 VPC는 "AWS-ELB" 가용영역은 "ap-northeast-2c"를 선택합니다.
10.IPv4 CIDR블록 입력상자에 "10.0.2.0/24"를 입력 후  생성단추를 누릅니다.
최종적으로 2개의 가용용역에 2개의 서브넷이 추가 생성된것을 확인합니다.
 
[인터넷 게이트 웨이(IGW) 생성후 VPC에 연결작업 수행]

1.좌측 VPC 대시보드아래 인터넷 게이트 웨이를 클릭하고 인터넷 게이트 웨이생성 단추를 클릭합니다.

2.인터넷 게이트웨이 생성화면에서 인터넷 게이트웨이 설정의 이름 태그에 "AWS-ELB-IGW"입력하고
인터넷 게이트웨이 생성단추를 클릭하여 생성

3.좌측 VPC 대시보드아래  인터넷 게이트웨이를 클릭해보면 인터넷 게이트웨이가 생성되었지만 VPC와 연결되어있지 않은 ‘detached’ 상태이므로 만들어진 AWS-ELB-IGW를 선택한 후 화면상단의 작업단추에서 VPC연결메뉴를 선택하여 사용 가능한 VPC에 AWS-ELB-IGW를 선택후 인터넷게이트웨이 연결단추를 클릭하여 AWS-ELB-IGW가 Attached 상태로 표시되는가 확인합니다

[라우팅테이블 편집]

1.좌측 VPC 대시보드아래 라우팅 테이블부분을 클릭하고 표시되는 이전 작업에서 생성한 vpc-0e628ed1210493536 | ELB-VPC 를 선택하고 화면 하단의 라우팅탭을 클릭하고 라우팅편집탭을 클릭하여 라우팅편집화면에서 라우팅 추가 단추를 클릭하여 AWS-ELB-IGW에 대해 첫번째 대상입력상자에서 0.0.0.0/0을 선택하고 두번쨰 대상입력상자에서 "igw-0009a6541883b4c8a AWS-ELB-IGW"을 선택하고 라우팅저장단추를 클릭하면 라우팅 편집되었습니다 화면이 표시되고 닫기단추를 누르면 최종 변경 정보가 저장됩니다.

2.닫기단추 클릭 후 추가된 라우팅정보가 아래와 같은 형태로 표시되어 활성화되어 표시됨을 확인합니다.
0.0.0.0/0 igw-0009a6541883b4c8a   active    아니요

3.계속하여 라우팅테이블 화면에서 서브넷연결탭을 클릭하고  서브넷연결편집단추를 클릭하여 라우팅테이블을적용할 서브넷들을연결합니다.이전 실습에서 만든 A와 C 서브넷이 표시되면 둘다 선택하고 저장단추를 눌러 서브넷 연결편집을 완료합니다. 

4.라우팅테이블 화면에서 연결된 10.0.1.0/24,10.0.2.0/24 두개의 서브넷이 연결되어 표시 될것입니다.

5.좌측보안그룹메뉴를 클릭하고 화면 상단의 보안그룹을 생성단추를 클릭하여 인스턴스 레벨의 인바운드, 아웃바운드 트래픽을 제어하기 위한 보안그룹을 생성

6.보안그룹생성화면에서 보안 그룹 이름을 "aws-elb-sg-webserver"라 입력하고 설명에 "security group for webserver"로 입력후 VPC에서 ELB-VPC선택 후 아래 2개의 인바운드 규칙만 추가
프로토콜은 http와 ssh 에 대해 소스는 "위치무관" 선택후 화면을 아래로 스크롤하여 보안그룹생성 단추 클릭하여 생성된 4개의 인바운드 규칙(4 권한 항목)이 만들어져서 표시되는지 확인

[ELB 테스트 실습을 위한 웹서버생성]

1.ec2서비스를 검색하여 1번째 웹서버 작성
단계 1: Amazon Machine Image(AMI) 선택화면에서 Amazon Linux 2 AMI (HVM), SSD Volume Type 선택

2.단계 2: 인스턴스 유형 선택에서 기본선택 확인후 화면하단의 다음:인스턴스세부정보 구성 단추 클릭

3.아래정보로 인스턴스 세부 정보 구성에서 웹 서버(현재 생성 중인 인스턴스)가 위치할 VPC, 서브넷을 지정합니다.또한, 인터넷에서 인스턴스에 연결할 수 있도록 퍼블릭 IP 할당을 활성화합니다. 그 후, 스크롤을 내려 추가 설정을 수행합니다.

네트워크:ELB-VPC선택
서브넷:aws-elb subnet2a 선택
퍼블릭 IP 자동 할당:활성화

4.설정이 되었으면 화면을 아래로 스크롤하여 고급 세부 정보를 확장하여 사용자 데이터에 아래와같은 구성 스크립트를 입력함으로써 Apache, PHP가 설치된 웹 페이지가 배포되게 합니다.(입력시 반드시 #include와 https://s3.amazonaws.com/immersiondaylabs/bootstrap.sh는 2줄에 걸쳐 입력합니다

#include
https://s3.amazonaws.com/immersiondaylabs/bootstrap.sh

5.위의 스크립트 코드를 정확히 입력하였으면 화면 하단의 다음:스토리지추가 단추를 클릭후 기본값이 표시되는지 확인하고 다음:name 태그추가 단추를 클릭하고 name태그가 표시되면 값으로 "AWS-ELB-WEBserver1" 입력하고  다음:보안그룹구성 단추를 클릭

6.보안 그룹 연결화면에서 보안 그룹 할당에서 기존생성된 "aws-elb-sg-webserver" 보안 그룹 선택후 검토및 시작 단추를 클릭하여  단계 7: 인스턴스 시작 검토 화면에서 시작단추를 눌러 EC2인스턴스 생성하고 접속시 필요한 키를 생성 이번 실습에서는 필요하지 않지만, 향후 SSH 클라이언트로 접속 할 경우 필요하므로 "aws-elb-key" 란 이름으로 생성(인스턴스 시작단추 클릭)
생성된 EC2 Webserver 인스턴스를 클릭하고 작업메뉴의 연결 메뉴를 통해 EC2인스턴스에 연결탭 아래 연결을 클릭하여 연결이 잘되는가를 확인해 봅니다
(시간이 되면 연결 후 rpm -qa | grep php*  또는 httpd*로 Apache, PHP가 설치 확인) 

7.인스턴스의 공용 ip주소를 복사 하여 브라우저에서 붙여넣기를 하여 웹서버기본 페이지가 나타나는지 확인해 봅니다.

위의 절차를 반복하여 서브넷:aws-elb subnet2c를 선택하여 aws-elb-sg-webserver2 인스턴스를  추가작성합니다.

[ELB 구성]
1.좌측 EC2 대시보드아래 로드 밸런싱섹션의 로드밸런싱을 확장하고 로드밸런서를 클릭하고 "Load Balancer생성" 단추를 클릭합니다.

2.Load Balancer 유형 선택 화면에서 application load balancer의 생성단추를 클릭합니다.

3.1단계: Load Balancer 구성화면의 기본구성부분의 이름을 "AWSLab-ELB"를 입력하고 리스너부분의 로드밸런서프로토콜이 http가 선택되어 있는지 확인하고 아래 가용영역의 VPC가 ELB-VPC가 선택되어 표시되면 가용 영역에 사전 구성해 둔 서브넷인 ap-northeast-2a와 ap-northeast-2c가 표시되어 있으면 선택하여 지정합니다. 다음:보안설정구성 단추를 클릭합니다.

4.2단계: 보안 설정 구성화면이 표시되면 하단의 다음:보안그룹구성 단추를 클릭합니다.

5.3단계: 보안 그룹 구성화면에서 웹서버를 위해 만든 보안그룹인 aws-elb-sg-webserver를 선택합니다. 다음:라우팅을 클릭합니다.

6.4단계: 라우팅 구성화면에서 새대상그룹이름에 "aws-ELB-Webserver-Targetgroup"을 입력하고 하단 고급 상태 검사 설정을 확장하여 표시된임계값인 5,2,5,30,200을 확인합니다.

참고로 값의미는 아래와 같습니다.
*정상/비정상 임계 값 : 정상/비정상을 결정하기 위한 연속된 실패/성공 확인 횟수
*제한시간 : 상태 확인 응답 대기시간
*간격 : 인스턴스 상태 확인 간격
*성공 코드 : 응답 성공 확인 시 받을 HTTP 코드

7. 확인후 하단의 다음:대상등록 단추를 클릭합니다.

8.5단계: 대상 등록화면 하단에 표시된 2개의 웹서버인스턴스를 선택하고 등록된항목에 추가 단추를 클릭하여 화면 상단의 등록된 대상에 표시되는가를 확인하고 화면 하단의 다음:검토 단추를 클릭합니다.

9.6단계: 검토 화면에서 나타나는 설정값을 확인 후 하단의 생성 단추를 클릭합니다.

10.Load Balancer 생성 상태 화면에서 생성완료 정보가 표시되면 닫기를 클릭합니다.

11.만들어진 AWSLab-ELB 로드밸런서의 상태가 provisioning에서 active상태로 표시되면 화면하단 설명탭의 dns이름(예:AWSLab-ELB-1647788065.ap-northeast-2.elb.amazonaws.com)을 복사하고 웹브라우저를 열어 주소창에 복사된 주소를 붙여넣어 접속된 웹서버 기본 페이지가 표시되는가를 확인합니다.

정상적으로 표시된 웹페이지가 어느서버에서 처리했는가를 확인하고 브라우저 탭을 하나더 열어 이전에 복사한 주소를 다시한번 붙여넣기를 시도하여 나타난  웹페이지가 이전 웹서버가 아닌 다른 웹서버가 처리하여 표시하는 것을 확인합니다.(로드밸런서는 트래픽처리를 기본적으로 라운드로빈 방식으로 처리하므로 이과정을 반복하면 순차적으로 다른웹서버가 트래픽을 돌아가면서 처리하는 것을 확인 할  수 있습니다)

12.대상그룹을 클릭하여 생성된 aws-ELB-Webserver-Targetgroup을 클릭하여 health check를 확인합니다. 정상이라면 타겟들이 healthy로 표시 될 것입니다.
